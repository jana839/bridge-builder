name: Deploy to GitHub Pages (gh-pages, resilient)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-pages-${{ github.ref }}
  cancel-in-progress: true

env:
  # Set your custom domain here. Leave empty ("") to publish to the GitHub pages repo URL.
  CUSTOM_DOMAIN: "www.down7x.com"
  # Change this to "pnpm" or "bun" if you use a different package manager
  PACKAGE_MANAGER: "npm"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout full repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ "${PACKAGE_MANAGER}" = "pnpm" ]; then
            corepack enable
            corepack prepare pnpm@latest --activate
            pnpm install
          elif [ "${PACKAGE_MANAGER}" = "bun" ]; then
            curl -fsSL https://bun.sh/install | bash
            bun install
          else
            npm ci || npm install
          fi

      - name: Build (auto base detection)
        run: |
          repo=$(echo "${GITHUB_REPOSITORY}" | cut -d/ -f2)
          if [ -n "${CUSTOM_DOMAIN}" ]; then
            base="/"
          else
            base="/${repo}/"
          fi
          echo "Building with base: ${base}"
          if [ "${PACKAGE_MANAGER}" = "pnpm" ]; then
            pnpm run build --if-present -- --base "${base}"
          elif [ "${PACKAGE_MANAGER}" = "bun" ]; then
            bun run build --if-present -- --base "${base}"
          else
            npm run build --if-present -- --base "${base}"
          fi

      - name: Verify build output
        run: |
          if [ ! -d ./dist ]; then
            echo "ERROR: build did not produce ./dist. Listing workspace:" && ls -la
            exit 1
          fi
          ls -la ./dist | sed -n '1,200p'

      - name: Add CNAME for custom domain (if set)
        if: env.CUSTOM_DOMAIN != ''
        run: |
          mkdir -p ./dist
          echo "${{ env.CUSTOM_DOMAIN }}" > ./dist/CNAME
          echo "Wrote CNAME: $(cat ./dist/CNAME)"

      - name: Create SPA fallback (index -> 404)
        run: |
          if [ -f ./dist/index.html ]; then
            cp ./dist/index.html ./dist/404.html || true
            echo "Copied index.html -> 404.html"
          else
            echo "No index.html in dist to copy"
          fi

      - name: Deploy to gh-pages (force orphan, resilient)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com
          allow_empty_commit: true
          commit_message: "Deploy to gh-pages: ${{ github.sha }}"
